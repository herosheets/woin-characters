angular = require('angular');

angular.module('woin-character')
  .service('ExploitService', ['$rootScope', function($rootScope) {

    var meetsCareerRequirements = function(character, exploit, exploitData) {
      console.log("entered meetsCareerRequirements: " + exploit);
      var exploitRequirements = exploitData[exploit].career_exploit_prereq.split(',');
      console.log("Looking for exploit: " + exploit);
      console.log("Requirements are: ");
      console.log(exploitRequirements);
      var meetsRequirements = true;
      if (exploitRequirements !== undefined) {
        angular.forEach(exploitRequirements, function(requirement) {
          if (requirement !== undefined && requirement !== '') {
            meetsRequirements = meetsRequirements &&  _.find(character.exploits, { Exploit: requirement })
          }
        });
      }
      console.log("Character meets requirement? " + meetsRequirements);
      return meetsRequirements;
    };


    var attributePrereq = function(attribute, value) {
      return {
        meets: function(character) {
          console.log("Character meets attribute: " + attribute + " > " + value);
          return true;
        }
      }
    }

    var skillPrereq = function(skillName) {
      return {
        meets: function(character) {
          console.log("Character meets skill: " + skillName);
          return true;
        }
      }

    }

    var exploitPrereq = function(exploitName) {
      return {
        meets: function(character) {
          console.log("Character meets exploit: " + exploitName);
          return true;
        }
      }

    }

    var loadPrerequisite = function(token) {
      console.log("Parsing prereq:" + token)
      var tokens = token.split(':');
      var prereq;
      switch (tokens[0]) {
        case "attribute":
          prereq = attributePrereq(tokens[1],tokens[2]);
          break;
        case "skill":
          prereq = skillPrereq(tokens[1]);
          break;
        case "exploit":
          prereq = exploitPrereq(tokens[1]);
          break;
        default:
          console.log("No valid prereq found: " + tokens[0]);
      }
      return prereq;
    };

    var getPrerequisitesFromExploit = function(exploit) {
      var prereqs = [];
      if (exploit.prereq !== undefined) {
        var tokens = [exploit.prereq];
        if (exploit.prereq.indexOf(';') >= 0) {
          tokens = exploit.prereq.split(';');
        }
        angular.forEach(tokens, function(token) {
          prereqs.push(loadPrerequisite(token));
        })
      }
      return prereqs;
    };

    var meetsPrerequisites = function(character, exploit) {
      var prerequisites = getPrerequisitesFromExploit(exploit);
      var meetsPrereq = true;
      angular.forEach(prerequisites, function(prereq) {
        meetsPrereq = meetsPrereq && prereq.meets(character);
      })
      return meetsPrereq;
    };

    return {
      meetsCareerRequirements: meetsCareerRequirements,
      meetsPrerequisites: meetsPrerequisites
    };
  }])